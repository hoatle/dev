dist: xenial

git:
  depth: 1

install: true

jobs:
  include:
    - stage: "Check Style"
      script: docker-compose run --rm verify bash -c "bundle install && bundle exec rubocop"

    - stage: "Tests"
      name: "tests"
      script: docker-compose run --rm verify bash -c "bundle install && bundle exec rspec"

    - stage: Publish
      env:
        - DOCKER_FILE=Dockerfile CI_REGISTRY_IMAGE=$DOCS_DOCKER_IMAGE CI_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      before_script:
        - chmod ugo+x ./.travis/deploy.sh
        - git config --global user.name "Teracy Bot"
        - git config --global user.email "teracy.com@gmail.com"
        - export REPO_URL="https://$GH_TOKEN@github.com/$GH_REPO.git"
        - . ./.travis/setup.sh
        - echo $DEPLOY_HTML_DIR
        - export TAG=`echo $TRAVIS_BRANCH | sed -e 's/[\/]/-/g' | sed -e 's/[\#]//g'`
        - export CI_COMMIT_SHORT_SHA=$(git rev-parse --short HEAD)
        - export CONTAINER_IMAGE=$CI_REGISTRY_IMAGE:$TAG-$CI_COMMIT_SHORT_SHA
      script: ./.travis/deploy.sh

